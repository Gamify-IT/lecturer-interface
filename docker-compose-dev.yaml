version: "3.7"

x-templates:
  template-service: &template-service
    restart: unless-stopped
    pull_policy: always
    expose:
      - "80"

  template-db: &template-db
    <<: *template-service
    image: postgres:14-alpine
    expose:
      - "5432"
    environment:
      - PGDATA=/var/lib/postgresql/data/pgdata
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres

services:

  #test-data
  test-data:
    <<: *template-service
    container_name: dev-test-data
    image: ghcr.io/gamify-it/test-data:latest
    environment:
      POSTGRES_SETUP: >
        bugfinder/default.sql
        chickenshock/default.sql
        crosswordpuzzle/default.sql
        finitequiz/default.sql
        keycloak/default.sql
        overworld/default.sql

  # default
  overworld-db:
    <<: *template-db
    container_name: dev-overworld-db

  overworld-backend:
    <<: *template-service
    container_name: dev-overworld-backend
    image: ghcr.io/gamify-it/overworld-backend:main
    depends_on:
      - overworld-db
    environment:
      - POSTGRES_URL=postgresql://dev-overworld-db:5432/postgres
      - KEYCLOAK_ISSUER=http://localhost/keycloak/realms/Gamify-IT
      - KEYCLOAK_URL=http://dev-keycloak/keycloak/realms/Gamify-IT
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - BUGFINDER_URL=http://dev-bugfinder-backend/api/v1
      - CHICKENSHOCK_URL=http://dev-chickenshock-backend/api/v1
      - CROSSWORDPUZZLE_URL=http://dev-crosswordpuzzle-backend/api/v1
      - FINITEQUIZ_URL=http://dev-finitequiz-backend/api/v1

  landing-page:
    <<: *template-service
    container_name: dev-landing-page
    image: ghcr.io/gamify-it/landing-page:main

  overworld:
    <<: *template-service
    container_name: dev-overworld
    image: ghcr.io/gamify-it/overworld:main

  privacy-policy:
    <<: *template-service
    container_name: dev-privacy-policy
    image: ghcr.io/gamify-it/privacy-policy:main

  third-party-license-notice:
    <<: *template-service
    container_name: dev-third-party-license-notice
    image: ghcr.io/gamify-it/third-party-license-notice:main

  reverse-proxy:
    <<: *template-service
    container_name: dev-reverse-proxy
    image: ghcr.io/gamify-it/reverse-proxy:main
    environment:
      - DEPLOYMENT_NAME=dev
      - SSL_ENABLED=false
    volumes:
      - ./.nginx/compose/body-main-dev.conf:/app/gamify-it/template/body-main.conf:ro
    ports:
      - "80:80"

  # bugfinder
  bugfinder-db:
    <<: *template-db
    container_name: dev-bugfinder-db

  bugfinder-backend:
    <<: *template-service
    container_name: dev-bugfinder-backend
    image: ghcr.io/gamify-it/bugfinder-backend:main
    depends_on:
      - bugfinder-db
    environment:
      - KEYCLOAK_ISSUER=http://localhost/keycloak/realms/Gamify-IT
      - KEYCLOAK_URL=http://dev-keycloak/keycloak/realms/Gamify-IT
      - OVERWORLD_URL=http://dev-overworld-backend/api/v1
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_URL=postgresql://dev-bugfinder-db:5432/postgres

  bugfinder:
    <<: *template-service
    container_name: dev-bugfinder
    image: ghcr.io/gamify-it/bugfinder:main

  # chickenshock
  chickenshock-db:
    <<: *template-db
    container_name: dev-chickenshock-db

  chickenshock-backend:
    <<: *template-service
    container_name: dev-chickenshock-backend
    image: ghcr.io/gamify-it/chickenshock-backend:main
    depends_on:
      - chickenshock-db
    environment:
      - POSTGRES_URL=postgresql://dev-chickenshock-db:5432/postgres
      - KEYCLOAK_ISSUER=http://localhost/keycloak/realms/Gamify-IT
      - KEYCLOAK_URL=http://dev-keycloak/keycloak/realms/Gamify-IT
      - OVERWORLD_URL=http://dev-overworld-backend/api/v1
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres

  chickenshock:
    <<: *template-service
    container_name: dev-chickenshock
    image: ghcr.io/gamify-it/chickenshock:main

  # crosswordpuzzle
  crosswordpuzzle-db:
    <<: *template-db
    container_name: dev-crosswordpuzzle-db

  crosswordpuzzle-backend:
    <<: *template-service
    container_name: dev-crosswordpuzzle-backend
    image: ghcr.io/gamify-it/crosswordpuzzle-backend:main
    depends_on:
      - crosswordpuzzle-db
    environment:
      - POSTGRES_URL=postgresql://dev-crosswordpuzzle-db:5432/postgres
      - KEYCLOAK_ISSUER=http://localhost/keycloak/realms/Gamify-IT
      - KEYCLOAK_URL=http://dev-keycloak/keycloak/realms/Gamify-IT
      - OVERWORLD_URL=http://dev-overworld-backend/api/v1
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres

  crosswordpuzzle:
    <<: *template-service
    container_name: dev-crosswordpuzzle
    image: ghcr.io/gamify-it/crosswordpuzzle:main

  # fileserver
  fileserver-db:
    <<: *template-db
    container_name: dev-fileserver-db

  fileserver:
    <<: *template-service
    container_name: dev-fileserver
    image: ghcr.io/gamify-it/sharry-fileserver:main
    depends_on:
      - fileserver-db
    environment:
      - BASE_URL=http://localhost
      - POSTGRES_URL=postgresql://dev-fileserver-db:5432/postgres
      - KEYCLOAK_CLIENT_ID=fileserver
      - KEYCLOAK_CLIENT_SECRET=test-client-secret
      - KEYCLOAK_ISSUER=http://localhost/keycloak/realms/Gamify-IT
      - KEYCLOAK_URL=http://dev-keycloak/keycloak/realms/Gamify-IT
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres

  # finitequiz
  finitequiz-db:
    <<: *template-db
    container_name: dev-finitequiz-db

  finitequiz-backend:
    <<: *template-service
    container_name: dev-finitequiz-backend
    image: ghcr.io/gamify-it/finitequiz-backend:main
    depends_on:
      - finitequiz-db
    environment:
      - POSTGRES_URL=postgresql://dev-finitequiz-db:5432/postgres
      - KEYCLOAK_ISSUER=http://localhost/keycloak/realms/Gamify-IT
      - KEYCLOAK_URL=http://dev-keycloak/keycloak/realms/Gamify-IT
      - OVERWORLD_URL=http://dev-overworld-backend/api/v1
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres

  finitequiz:
    <<: *template-service
    container_name: dev-finitequiz
    image: ghcr.io/gamify-it/finitequiz:main

  # keycloak
  keycloak-db:
    <<: *template-db
    container_name: dev-keycloak-db

  keycloak:
    <<: *template-service
    container_name: dev-keycloak
    image: ghcr.io/gamify-it/keycloak:main
    depends_on:
      - keycloak-db
    environment:
      - KEYCLOAK_ADMIN=admin
      - KEYCLOAK_ADMIN_PASSWORD=admin
      - KC_DB_URL=jdbc:postgresql://dev-keycloak-db:5432/postgres
      - KC_HOSTNAME_URL=http://localhost/keycloak
      - SKIP_IMPORT=true

  # memory
  memory-db:
    <<: *template-db
    container_name: dev-memory-db

  memory-backend:
    <<: *template-service
    container_name: dev-memory-backend
    image: ghcr.io/gamify-it/memory-backend:main
    depends_on:
      - memory-db
    environment:
      - POSTGRES_URL=postgresql://dev-memory-db:5432/postgres
      - KEYCLOAK_ISSUER=http://localhost/keycloak/realms/Gamify-IT
      - KEYCLOAK_URL=http://dev-keycloak/keycloak/realms/Gamify-IT
      - OVERWORLD_URL=http://dev-overworld-backend/api/v1
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres

  memory:
    <<: *template-service
    container_name: dev-memory
    image: ghcr.io/gamify-it/memory:main

  # regexgame
  regexgame-db:
    <<: *template-db
    container_name: dev-regexgame-db

  regexgame-backend:
    <<: *template-service
    container_name: dev-regexgame-backend
    image: ghcr.io/gamify-it/regexgame-backend:main
    depends_on:
      - regexgame-db
    environment:
      - POSTGRES_URL=postgresql://dev-regexgame-db:5432/postgres
      - KEYCLOAK_ISSUER=http://localhost/keycloak/realms/Gamify-IT
      - KEYCLOAK_URL=http://dev-keycloak/keycloak/realms/Gamify-IT
      - OVERWORLD_URL=http://dev-overworld-backend/api/v1
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres

  regexgame:
    <<: *template-service
    container_name: dev-regexgame
    image: ghcr.io/gamify-it/regexgame:main

  # towercrush
  towercrush-db:
    <<: *template-db
    container_name: dev-towercrush-db

  towercrush-backend:
    <<: *template-service
    container_name: dev-towercrush-backend
    image: ghcr.io/gamify-it/towercrush-backend:main
    depends_on:
      - bugfinder-db
    environment:
      - POSTGRES_URL=postgresql://dev-towercrush-db:5432/postgres
      - KEYCLOAK_ISSUER=http://localhost/keycloak/realms/Gamify-IT
      - KEYCLOAK_URL=http://dev-keycloak/keycloak/realms/Gamify-IT
      - OVERWORLD_URL=http://dev-overworld-backend/api/v1
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres

  towercrush:
    <<: *template-service
    container_name: dev-towercrush
    image: ghcr.io/gamify-it/towercrush:main
